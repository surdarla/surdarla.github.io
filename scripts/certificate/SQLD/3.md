# 3. SQL 기본

```{figure} https://th.bing.com/th/id/OIP.-KvoMKZ3ekyioo7aFrQgMgHaHH?pid=ImgDet&rs=1
```

## 1. 관계형 DB

DB\
데이터를 일정한 형태로 저장해 놓은 것\
DBMS를 이용하여 효율적인 데이터 관리와 데이터 손상 복구 가능\

**종류**

- 계층형 DB : 트리 형태의 자료구조에 데이터 저장, 1:N 관계 표현
- 네트워크형 DB : 오너와 멤버 형태로 데이터 저장, M:N 관계 표현
- 관계형 DB : 릴레이션에 데이터 저장, 집합 연산과 관계 연산 가능

**관계형 DB(RDB;Relational Database)**

1. 정규화를 통해 이상현상 및 중복 데이터 제거
2. 동시성 관리와 병행 제어를 통해 데이터 동시 조작 가능

**집합 연산**

- 합집합(Union)
- 차집합(Difference)
- 교집합(Intersection)
- 곱집합(Cartesian Product) : 각 릴레이션에 존재하는 모든 데이터를 조합

**관계 연산**

- 선택 연산(Selection) : 조건에 맞는 행(튜플) 조회
- 투영 연산(Projection) : 조건에 맞는 컬럼(속성) 조회
- 결합 연산(Join) : 공통 속성을 사용하여 새로운 릴레이션 생성
- 나누기 연산(Division) : 공통 요소를 추출, 분모 릴레이션의 속성을 삭제한 후 중복된 행 제거

**SQL**

- RDB에서 사용하는 언어
- 데이터 조회,입력,수정,삭제 기능 제공

1. DML(Data Manipulation Language, 데이터 조작어) ISUD
   1. SELECT: 조회
   2. INSERT, UPDATE, DELETE: 변형
2. DDL(Data Definition Language, 데이터 정의어) CADRT
   1. 데이터 구조에 관련 명령어
   2. CREATE, ALTER, DROP, RENAME
3. DCL(Data Control Language, 데이터 제어어)
   1. DB 접근 권한 부여 및 회수
   2. GRANT, REVOKE
4. TCL(Transaction Control Language, 트랜잭션 제어어)
   1. DML로 조작한 결과를 논리적인 작업 단위 별로 제어
   2. COMMIT, ROLLBACK

**Table 테이블**
RDB의 기본단위, 데이터를 저장하는 객체, column-row 2차원 구조\
Field 필드 : 컬럼과 행이 겹치는 하나의 공간

```{figure} https://dataonair.or.kr/publishing/img/knowledge/SQL_156.jpg
선수와 관련된 데이터를 저장할 때 모든 데이터를 하나의 테이블로 저장하지 않는다. [그림 Ⅱ-1-5]를 보면 선수와 관련된 데이터를 선수 테이블과 구단 테이블이라는 복수의 테이블로 분할하여 저장하고 있다.

그리고 분할된 테이블은 그 칼럼의 값에 의해 연결된다. 이렇게 테이블을 분할하여 데이터의 불필요한 중복을 줄이는 것을 정규화(Normalization)라고 한다. 데이터의 정합성 확보와 데이터 입력/수정/삭제시 발생할 수 있는 이상현상(Anomaly)을 방지하기 위해 정규화는 관계형 데이터베이스 모델링에서 매우 중요한 프로세스이다.
```

### 2. DDL : CADRT

```{figure} https://dataonair.or.kr/publishing/img/knowledge/SQL_162.jpg
데이터 유형은 데이터베이스의 테이블에 특정 자료를 입력할 때, 그 자료를 받아들일 공간을 자료의 유형별로 나누는 기준이라고 생각하면 된다
```

**데이터 타입**(Oracle,SQL Server 형식, 괄호안은 조건)

- CHAR(L) : 고정 길이 문자열, 할당된 변수 값의 길이가 L 이하 일때 차이는 공백으로 채움
- VARCHAR2(L),VARCHAR(L) : 가변 길이 문자열, 할당되는 변수 값의 길이의 최대값이 L임. 문자열은 가능한 최대 길이로 설정
- NUMBER(L,D) : 숫자형(L은 전체자리수, D는 소수점 자리수)
  - SQL Server은 NUMERIC, DECIMAL, FLOAT, REAL 등 존재
- DATE, DATETIME : 날짜형, 데이터 크기 지정이 필요하지 않음

### 2.1 CREATE TABLE

- 테이블 및 컬럼 명명 규칙
  - 알파벳
  - 숫자
  - _ 언더바
  - 달러 $
  - 샵 \#
- 대소문자 구분하지 않음
- 단수형 권고

**제약조건**

- **PRIMARY KEY**
  - 테이블 당 하나의 기본키만 정의 가능
  - 기본키 생성시 DBMS가 자동으로 인덱스를 생성
  - NULL 불가
- **FOREIGN KEY**
  - 으로 다른 테이블의 기본키를 외래키로 지정
  - 참조 무결성 제약 옵션 선택가능
  - `ALTER TABLE 테이블명 ADD CONSTRAINT 컬럼명 FOREIGN KEY (컬럼명) REFERENCES`
- **UNIQUE KEY**
  - 행 데이터를 식별하기 위해 생성
  - NULL 가능
- DEFAULT
  - DEFAULT 값으로 기본값 설정
- NOT NULL
  - NULL : 아직 정의되지 않은 값 또는 현재 데이터를 입력하지 못하는 값 수치연산NULL 비교연산FALSE
- CHECK
  - 입력값의 종류 및 범위 제한

**DESCRIBE 테이블명** sp_help 'dbo.테이블명'
테이블 구조 확인\
DESCRIBE 테이블명 이 ANSI/ISO 표준

### 2.2 ALTER TABLE

> 테이블의 컬럼 관련 변경 명령어

1. 컬럼 추가
   1. `ALTER TABLE 테이블명 ADD (칼럼명 데이터타입)`
   2. 마지막 컬럼으로 추가됨
   3. 컬럼 위치 지정 불가
2. 컬럼 삭제
   1. `ALTER TABLE 테이블명 DROP COLUMN 칼럼명`
   2. 삭제 후 복구 불가
3. 컬럼 설정 변경
   1. `ALTER TABLE 테이블명 MODIFY (칼럼명 데이터타입 제약조건)`
   2. NULL만 있거나 행이 없는 경우에만 컬럼 크기 축소 가능
   3. NULL만 있을떄 - 데이터 유형도 변경 가능
   4. NULL이 없으면 NOT NULL 제약조건 추가 가능
   5. 기본값 변경 작업 이후 발생하는 데이터에 대해서만 기본값이 변경됨
4. 컬럼명 변경
   1. `ALTER TABLE 테이블명 RENAME COLUMN 칼럼명`
   2. ANSI/ISO 표준에 명시된 기능이 아님
5. 제약조건 추가
   1. `ALTER TABLE 테이블명 ADD CONSTRAINT 제약조건`
6. 제약조건 제거
   1. `ALTER TABLE 테이블명 DROP CONSTRAINT 제약조건`

### 2.3 RENAME TABLE

`ALTER TABLE 테이블명 RENAME TO 테이블명`도 가능\

### 2.4 DROP TABLE

테이블의 데이터와 구조 삭제, **복구 불가**\
`CASCADE CONSTRAINT` 옵션으로 관련 테이블의 참조 제약조건도 삭제하여 참조 무결성을 준수할 수 있음. `CREATE TABLE에서 ON DELETE CASCADE 옵션으로도 동일 기능 실현 가능`

### 2.5 TRUNCATE TABLE

테이블의 전체 데이터 삭제 <-> DROP TABLE은 테이블 자체를 제거함\
로그를 기록하지 않기 때문에 ROLLBACK 불가

## 3. DML : IUDS

- INSERT
  - 데이터 입력
  - `INSERT INTO 테이블명 (칼럼명, …) VALUES (필드값, …)`
  - `INSERT INTO 테이블명 VALUES (필드값, …)`
- UPDATE
  - 데이터 수정
  - `UPDATE 테이블명 SET 칼럼명=필드값;`
- DELETE
  - 데이터 삭제
  - `DELETE FROM 테이블명 WHERE 조건절`
  - `DELETE FROM 테이블명`
  - DELETE로 데이터를 삭제해도 테이블 용량은 초기화되지 않음
  - TRUNCATE로 삭제하면 초기화됨
  - DROP은 객체 삭제 명령어
- SELECT
  - 컬럼별 데이터 선택 : `SELECT 칼럼명 FROM 테이블명`
  - 데이터 중복 없이 선택 : `SELECT DISTINCT 칼럼명 FROM 테이블명`
  - 전체 컬럼의 데이터 선택 : `SELECT * FROM 테이블명`
  - ALIAS
    - SELECT 컬럼명 AS '별명'
    - FROM 테이블명 별명 : 쿼리 내에서 사용할 테이블명 설정, 컬럼명이 중복될 경우 SELECT절에서 앨리어스 필수
- 합성 연산자(문자열)
  - +, CONCAT(ORACLE : ||로도 가능)
- DUAL : 오라클 기본 더미 테이블, 연산 수행을 위해 사용됨

## 4. TCL : UID

> **트랜잭션**
> DB의 논리적 연산 단위, 하나 이상의 SQL문을 포함함\
> 데이터 무결성 보장을 목적으로 함\
> 1) 영구 변경 전 확인 + 2) 연관작업 동시 처리 가능\
> 밀접히 관련되어 분리될 수 없는 한 개 이상의 데이터베이스 조작\
> 하나의 트랜잭션에는 하나 이상의 SQL 문장이 포함\
> 분할할 수 없는 최소의 단위
> DB를 정상적으로 종료하면 자동 커밋, 앱 등의 이상으로 DB접속이 단절되면 자동 롤백

```{figure} https://dataonair.or.kr/publishing/img/knowledge/SQL_170.jpg
```

### 4-1 COMMIT

> 데이터를 DB에 영구적으로 반영하는 명력어\
> 커밋 시 트랜잭션이 완료되어 LOCKING이 해제됨\
> SQL SERVER는 기본적으로 자동 커밋

**COMMIT 전**
- 데이터 변경이 메모리 버퍼에만 영향을 받았기 때문에 복구 가능
  - NOLOGGING 옵션 사용시 버퍼 캐시의 기록을 생략하여 입력 성능이 향상됨
- 사용자는 SELECT 절로 결과를 확인할 수 있으나 다른 사용자는 현재 결과를 볼 수 없음
- 변경된 행에 LOCKING이 설정되어 다른 사용자가 변경할 수 없음
  - LOCKING이 안 걸린 상태일 때 여러 사용자가 데이터를 변경하면 상관없음

**COMMIT 후**
- 변경 사항이 DB에 반영
- 이전 데이터 복구 불가
- 모든 사용자가 결과를 볼 수 있음
- LOCKING이 해제되어 다른 사용자가 행을 조작할 수 있음

### 4-2 ROLLBACK

> 트랜잭션 시작 이전의 상태로 되돌리는 명령어\
> COMMIT 이전 상태로 돌려줌\
> ROLLBACK 시 LOCKING이 해재됨

- SAVEPOING : 트랜잭션 일부만 롤백 할 수 있도록 중간상태를 저장하는 명령어
  - `ROLLBACK TO 저장점명` : 해당 저장점 상태로 되돌림
  - 동일한 저장점명이 있으면 최후 저장점이 유효
- SQL SERVER에서는 `BEGINE TRAN`으로 명시해야 하능

## 5. DCL

> 유저를 생성하거나 권한을 제어하는 명령어, 보안을 위해 필요함

- GRANT : 권한 부여, `GRANT 권한 ON 오브젝트 TO 유저명`
- REVOKE : 권한 제거,  `REVOKE 권한 ON 오브젝트 TO 유저명`

**권한**
- SELECT, INSERT, UPDATE, ALTER, ALL - DML 관련 권한
- REFERENCES : 지정된 테이블을 참조하는 제약조건을 생성하는 권한
- INDEX : 지정된 테이블에서 인덱스를 생성하는 권한

**ORACLE 유저**
- SCOTT :
- SYS :
- SYSTEM :

**ROLE**
- 권한의 집합
- 권한을 일일이 부여하지 않고 ROLE로 편리하게 여러 권한을 부여할 수 있음

```{figure} https://dataonair.or.kr/publishing/img/knowledge/SQL_226.jpg
ROLE에는 시스템 권한과 오브젝트 권한을 모두 부여할 수 있으며, ROLE은 유저에게 직접 부여될 수도 있고, 다른 ROLE에 포함하여 유저에게 부여될 수도 있다. Oracle에서는 기본적으로 몇 가지 ROLE을 제공하고 있다. 그 중 가장 많이 사용하는 ROLE은 CONNECT와 RESOURCE
```

CONNCECT ROLE의 권한은 CREATE SESSION 뿐이다. 나머지는 전부 RESOURCE다.

## 6. WHERE 조건절

`SELECT [DISTINCT/ALL] 칼럼명 [ALIAS명] FROM 테이블명 WHERE 조건식`

> WHERE 절은 FROM 절 다음에 위치하며, 조건식은 아래 내용으로 구성된다\
> 칼럼(Column)명 (보통 조건식의 좌측에 위치) - 비교 연산자 - 문자, 숫자, 표현식 (보통 조건식의 우측에 위치) - 비교 칼럼명 (JOIN 사용시)

```{figure} https://dataonair.or.kr/publishing/img/knowledge/SQL_172.jpg
```

```{figure} https://dataonair.or.kr/publishing/img/knowledge/SQL_177.jpg
LIKE의 사전적 의미는 ‘~와 같다’이다. 따라서 위와 같은 경우라면 비교 연산자인 ‘=’을 사용해서 작성해도 같은 결과를 얻을 수 있을 것이다. 그러나 만약 “장”씨 성을 가진 선수들을 조회할 경우는 어떻게 할까? 이런 문제를 해결하기 위해서 LIKE 연산자에서는 와일드카드(WildCard)를 사용할 수 있다. 와일드카드(WildCard)란 `한 개 혹은 0개 이상의 문자를 대신해서 사용하기 위한 특수 문자`를 의미하며, 이를 조합하여 사용하는 것도 가능하므로 SQL 문장에서 사용하는 스트링(STRING) 값으로 용이하게 사용할 수 있다.
```

```{figure} https://dataonair.or.kr/publishing/img/knowledge/SQL_175.jpg
```

### 6-1 부분 범위 처리

1. ROWNUM(oracle) : SQL 처리 결과 집합의 각 행에 임시로 부여되는 번호, 조건절 내에서 행의 개수를 제한하는 목적으로 사용함
2. TOP(SQL Server) : 출력 행의 수 제한 함수, TOP (N) 로 n개 행 출력, 개수 대신 비율로도 제한 가능. order by 절이 없으면 rownum과 top의 기능이 같음

## 7. 함수
